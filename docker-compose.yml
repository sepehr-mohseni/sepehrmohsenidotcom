services:
  # ===========================================
  # Portfolio Application
  # ===========================================
  portfolio:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: portfolio-app
    restart: unless-stopped
    expose:
      - "3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=file:/app/data/${DB_NAME:-portfolio}.db
      - NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL}
    volumes:
      - portfolio-data:/app/data
    networks:
      - portfolio-network
    labels:
      # Traefik configuration
      - "traefik.enable=true"
      - "traefik.http.routers.portfolio.rule=Host(`${DOMAIN}`) || Host(`www.${DOMAIN}`)"
      - "traefik.http.routers.portfolio.entrypoints=websecure"
      - "traefik.http.routers.portfolio.tls.certresolver=letsencrypt"
      - "traefik.http.services.portfolio.loadbalancer.server.port=3000"
      # Redirect www to non-www
      - "traefik.http.middlewares.www-redirect.redirectregex.regex=^https://www\\.(.*)"
      - "traefik.http.middlewares.www-redirect.redirectregex.replacement=https://$${1}"
      - "traefik.http.middlewares.www-redirect.redirectregex.permanent=true"
      # Rate limiting
      - "traefik.http.middlewares.rate-limit.ratelimit.average=100"
      - "traefik.http.middlewares.rate-limit.ratelimit.burst=50"
      - "traefik.http.middlewares.rate-limit.ratelimit.period=1m"
      # Security headers
      - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.security-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.security-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
      # Apply middlewares
      - "traefik.http.routers.portfolio.middlewares=www-redirect,rate-limit,security-headers"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "1.5"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 256M

  # ===========================================
  # Traefik Reverse Proxy (Auto SSL)
  # ===========================================
  traefik:
    image: traefik:v2.11
    container_name: portfolio-traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    command:
      # API & Dashboard (disabled in production)
      - "--api.dashboard=false"
      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # HTTP to HTTPS redirect
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      # Let's Encrypt
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      # Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=portfolio-network"
      # Logging
      - "--log.level=WARN"
      - "--accesslog=false"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-certs:/letsencrypt
    networks:
      - portfolio-network
    profiles:
      - production

  # ===========================================
  # SQLite Web UI (for remote DB access)
  # ===========================================
  sqlite-web:
    image: coleifer/sqlite-web:latest
    container_name: portfolio-db-ui
    restart: unless-stopped
    ports:
      - "127.0.0.1:${DB_UI_PORT:-8080}:8080"
    environment:
      - SQLITE_DATABASE=/data/${DB_NAME:-portfolio}.db
    volumes:
      - portfolio-data:/data:ro
    networks:
      - portfolio-network
    profiles:
      - tools

volumes:
  portfolio-data:
    driver: local
  traefik-certs:
    driver: local

networks:
  portfolio-network:
    name: portfolio-network
    driver: bridge
